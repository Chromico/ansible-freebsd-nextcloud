---
# General vars including FreeBSD specific ansible tweaks
- hosts: nextcloud
  remote_user: ansible
  become: yes
  become_method: su
  gather_facts: False
  vars:
    ansible_python_interpreter: "/usr/local/bin/python"
  vars_files:
    - secrets/mysql.yml

# Prepare the raw basics to get working
  tasks:
  - name: Setup pkg directory
    file: path=/usr/local/etc/pkg/repos state=directory
    tags: osprep, doinstall

  - name: Disable 'quarterly' pkg repo, use 'latest' instead
    copy:
      src: files/{{item}}
      dest: /usr/local/etc/pkg/repos/{{item}}
    with_items:
      - FreeBSD.conf
      - FreeBSD-latest.conf
    tags: osprep, doinstall

  - name: Clear /tmp on startup
    lineinfile:
      path: /etc/rc.conf
      line: 'clear_tmp_enable=YES'
    tags: osprep, doinstall

# Install packages
  - name: Install required packages
    pkgng: name={{item}} state=present
    with_items:
      - nextcloud-php72
      - mysql56-server
      - nginx
      - redis
      - php72-pecl-redis
    tags: osprep, doinstall

  - name: Install optional packages for nextcloud
    pkgng: name={{item}} state=present
    with_items:
      - nextcloud-calendar-php72
      - nextcloud-contacts-php72
      - nextcloud-mail-php72
      - nextcloud-notes-php72
      - nextcloud-passman-php72
      - nextcloud-tasks-php72
      - nextcloud-twofactor_totp-php72
      - nextcloud-twofactor_u2f-php72
    tags: optional, doinstall

# Prepare database
  - name: Install database configuration file
    copy:
      src: files/my.cnf
      dest: /usr/local/etc/mysql/my.cnf
    tags: dbprep, doinstall

  - name: Create / set permissions for database work directories
    file:
      path: /data/{{item}}
      state: directory
      owner: mysql
      group: mysql
      mode: 0755
    with_items:
     - mysql
     - mysql/tmpdir
     - mysql/secure
     - mysql/innodb
     - mysql/innodb-logs
     - ../var/run/mysql
    tags: dbprep, doinstall

  - name: Set database dbdir in mysql startup
    lineinfile:
      path: /etc/rc.conf
      line: '{{item}}'
    with_items:
      - mysql_dbdir="/data/mysql"
      - mysql_pidfile="/var/run/mysql/mysqld.pid"
    tags: osprep, doinstall

  - name: Enable and run database service
    service:
      name: mysql-server
      enabled: yes
      state: started
    tags: dbprep, doinstall

  - name: Perform mysql_secure_install
    script: files/mysql_secure.sh {{ mysql_rootpw }}
    args:
      creates: /var/db/mysql_secure/MYSQL_SECURE_DONE
    tags: dbprep, postinstall

  - name: Setup database table and admin user for Nextcloud
    script: files/mysql_nextcloud_admin.sh {{ mysql_rootpw }} {{ mysql_ncuser }} {{ mysql_ncpass }}
    args:
      creates: /var/db/mysql_secure/MYSQL_NEXTCLOUD_ADMIN_DONE
    tags: dbprep, postinstall

# Prepare the webserver
  - name: Directory for certificates
    file:
      path: /data/nginx/ssl
      state: directory
      owner: www
      group: www
    tags: webprep, doinstall

  - name: Install SSL certificate
    copy:
      src: secrets/nginx.crt
      dest: /data/nginx/ssl/nginx.crt
      owner: www
      group: www
    tags: webprep, doinstall

  - name: Install server private key
    copy:
      src: secrets/nginx.key
      dest: /data/nginx/ssl/nginx.key
      mode: 0600
      owner: www
      group: www
    tags: webprep, doinstall

  - name: Install webserver config file
    copy:
      src: files/nginx.conf
      dest: /usr/local/etc/nginx/nginx.conf
    tags: webprep

  - name: Enable and run webserver
    service:
      name: nginx
      enabled: yes
      state: started
    tags: webprep, doinstall

# Prepare caching
  - name: Caching data folder
    file:
      path: /data/redis
      state: directory
      owner: redis
      group: redis
    tags: webprep, doinstall

  - name: Configure caching service
    copy:
      src: files/redis.conf
      dest: /usr/local/etc/redis.conf
    tags: cacheprep, doinstall

  - name: Enable and run caching service
    service:
      name: redis
      enabled: yes
      state: started
    tags: cacheprep, doinstall

  - name: Place memcache config snipped for php
    copy:
      src: files/memcache.redis.php
      dest: /usr/local/share/nextcloud/memcache.redis.php
    tags: cacheprep, postinstall

# Prepare php bits
  - name: Data folders for nextcloud data and php-fpm
    file:
      path: /data/{{item}}
      state: directory
      owner: www
      group: www
      mode: 0770
    with_items:
      - nextcloud
      - php-fpm
    tags: phpprep, doinstall

  - name: Install php.ini
    copy:
      src: files/php.ini
      dest: /usr/local/etc/php.ini
    tags: phpprep, doinstall

  - name: Log file for php-fpm
    copy:
      content: ""
      dest: /data/php-fpm/error.log
      force: no
      owner: www
      group: www
    tags: phpprep, doinstall

  - name: Configure log file location for php-fpm
    lineinfile:
      path: /usr/local/etc/php-fpm.conf
      regexp: 'error_log\s*='
      line: 'error_log = /data/php-fpm/error.log'
    tags: phpprep, doinstall

  - name: Configuration file for php-fpm
    copy:
      src: files/php-fpm.d.www.conf
      dest: /usr/local/etc/php-fpm.d/www.conf
    tags: phpprep, doinstall

  - name: Enable and run php-fpm
    service:
      name: php-fpm
      enabled: yes
      state: started
    tags: phpprep, doinstall
